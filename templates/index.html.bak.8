<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח משימות</title>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/" style="text-decoration: none; color: inherit;"><span>לוח משימות</span></a>
        </div>


        <div class="search-container"
            style="display: inline-block; vertical-align: middle; margin-left: 20px; position: relative;">
            <input type="text" id="searchBox" placeholder="חיפוש משימות..."
                style="padding: 0.4rem 2rem 0.4rem 1rem; border: 1px solid #ddd; border-radius: 20px; font-size: 0.9rem; width: 250px;">
            <button id="clearSearch"
                style="position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; display: none; color: #888; font-size: 1.1rem;">×</button>
        </div>
        <!-- Team Filter Buttons -->
        <div style="display: inline-block; margin-left: 1rem;">
            {% for team in teams %}
            <button class="filter-team-btn" data-team-id="{{ team.id }}"
                style="padding: 0.4rem 0.8rem; margin: 0 0.25rem; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                {{ team.name_he }}
            </button>
            {% endfor %}
            <button id="clearTeamFilter"
                style="padding: 0.4rem 0.8rem; margin: 0 0.25rem; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                הכל
            </button>
        </div>
        <div class="navbar-meta">
            <a href="/admin" title="ממשק ניהול"
                style="margin-left:16px;vertical-align:middle;display:inline-block;color:#555;">
                <img src="{{ url_for('static', filename='icons/settings.svg') }}" width="20" height="20" alt="Settings"
                    style="vertical-align:middle;">
            </a>

            <a href="/print" title="גרסת הדפסה"
                style="margin-left:16px;vertical-align:middle;display:inline-block;float:right;">
                <img src="{{ url_for('static', filename='icons/print.svg') }}" width="20" height="20" alt="Print"
                    style="vertical-align:middle;">
            </a>
            <img src="{{ url_for('static', filename='icons/clock.svg') }}" width="18" height="18" alt="Clock"
                style="vertical-align:middle;">
            <span id="liveClock" style="padding-right: 1px;"></span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">

        <header class="dashboard-header">
            <div class="dashboard-title">
                <!--╫£╫ץ╫ק ╫₧╫⌐╫ש╫₧╫ץ╫¬-->
                <button id="addTaskBtn" class="btn-add-task">
                    <img src="{{ url_for('static', filename='icons/plus.svg') }}" width="18" height="18" alt="Add"
                        style="vertical-align:middle;"> הוסף משימה
                </button>
            </div>
            <div class="filter-controls">


                <!-- Member Filter Buttons (existing) -->
                {% for member in members %}
                <button class="filter-avatar-btn" data-member="{{ member.name_en }}" data-team-id="{{ member.team_id }}"
                    title="{{ member.name_he }}">
                    <img src="{{ url_for('static', filename='images/' + member.avatar_path) }}" class="filter-avatar">
                </button>
                {% endfor %}
            </div>
        </header>

        <div class="projects-grid">
            {% for project in projects %}
            <div class="project-card"
                data-team-id="{{ tasks|selectattr('project', 'equalto', project)|map(attribute='team_id')|first }}">
                <div class="project-header">
                    <span class="project-title">
                        <button class="add-task-project-btn" data-project="{{ project }}" title="הוסף משימה לפרויקט זה"
                            style="background:none;border:none;cursor:pointer;padding:0 0 0 6px;vertical-align:middle;">
                            <img src="{{ url_for('static', filename='icons/plus-small.svg') }}" width="16" height="16"
                                alt="Add" style="vertical-align:middle;">
                        </button>
                        {{ project }}
                    </span>
                    {% set project_colors = [
                    {'bg': '#EEF2FF', 'color': '#4F46E5'},
                    {'bg': '#ECFDF5', 'color': '#10B981'},
                    {'bg': '#FFF7ED', 'color': '#F97316'},
                    {'bg': '#FEF2F2', 'color': '#EF4444'},
                    {'bg': '#F0F9FF', 'color': '#0EA5E9'},
                    {'bg': '#FDF2FF', 'color': '#A21CAF'},
                    {'bg': '#F1F5F9', 'color': '#0F172A'},
                    {'bg': '#FFFBEB', 'color': '#CA8A04'},
                    {'bg': '#E0F2FE', 'color': '#0369A1'},
                    {'bg': '#F3F4F6', 'color': '#7C3AED'},
                    {'bg': '#FDE68A', 'color': '#B45309'},
                    {'bg': '#D1FAE5', 'color': '#047857'},
                    {'bg': '#FECACA', 'color': '#B91C1C'},
                    {'bg': '#EDE9FE', 'color': '#7C3AED'},
                    {'bg': '#C7D2FE', 'color': '#1D4ED8'}
                    ] %}
                    {# Priority colors: high=red, medium=orange, low=yellow, none/empty=gray #}
                    {% set priority_colors = {
                    'high': '#ef4444',
                    'medium': '#f59e0b',
                    'low': '#fde047',
                    'none': '#cbd5e1',
                    '': '#cbd5e1'
                    } %}
                    {% set color = project_colors[(loop.index0) % project_colors|length] %}
                    <span class="project-badge" style="background-color: {{ color.bg }}; color: {{ color.color }};">{{
                        project_teams.get(project, 'ללא צוות') }}</span>
                </div>
                <div class="project-body">
                    <ul class="task-list">
                        {% for task in tasks if task.project == project %}
                        <li class="task-item" data-id="{{ task.id }}" data-notes="{{ task.notes|default('') }}"
                            data-priority="{{ task.priority|default('none') }}">
                            <div class="task-info">
                                <span class="task-marker"
                                    style="background-color: {{ priority_colors.get(task.priority, '#cbd5e1') }};"></span>
                                <span class="task-name">{{ task.task }}</span>
                                <span class="note-icon{% if not task.notes %} hidden{% endif %}" title="קיים הערות"
                                    style="vertical-align:middle;">
                                    <img src="{{ url_for('static', filename='icons/note.svg') }}" width="16" height="16"
                                        alt="Note" style="vertical-align:middle;">
                                </span>
                            </div>
                            <div class="task-actions">
                                <button class="btn-icon edit-btn" title="ערוך"></button>
                            </div>
                            <div class="task-meta">
                                <div class="avatar-group">
                                    {% set member_list = task.members.split(',') if task.members else [] %}
                                    {% for member_name in member_list %}
                                    {% set member_key = member_name|lower|trim %}
                                    {% if member_key %}
                                    {% set member_obj = members|selectattr('name_en', 'equalto', member_key)|first %}
                                    {% if member_obj %}
                                    <img src="{{ url_for('static', filename='images/' + member_obj.avatar_path) }}"
                                        onerror="this.src='{{ url_for('static', filename='images/default.png') }}'"
                                        class="avatar" title="{{ member_obj.name_he }}">
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="status-badge {{ task.status }}">{{ task.status|replace('status-inprogress',
                                    'בתהליך')|replace('status-done', 'הושלם')|replace('status-notstarted', 'טרם
                                    החל')|replace('status-delayed', 'מעוכב') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>



        <!-- Create Task Modal -->
        <div id="createTaskModal" class="modal">
            <div class="modal-content">
                <span class="close-modal-create">&times;</span>
                <h2 id="createModalTitle">יצירת משימה חדשה</h2>
                <div class="form-group">
                    <label for="createProjectNameInput">שם הפרויקט:</label>
                    <input type="text" id="createProjectNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label for="createTaskNameInput">שם המשימה:</label>
                    <input type="text" id="createTaskNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label>חברי צוות:</label>
                    <div class="members-select">
                        <!-- Populated dynamically by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="createTaskTeam">צוות:</label>
                    <select id="createTaskTeam" class="form-control">
                        <!-- Populated dynamically by JavaScript -->
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="createTaskStatus">סטטוס:</label>
                        <select id="createTaskStatus" class="form-control">
                            <option value="status-inprogress">בתהליך</option>
                            <option value="status-done">הושלם</option>
                            <option value="status-notstarted">טרם החל</option>
                            <option value="status-delayed">מעוכב</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label for="createTaskPriority">עדיפות:</label>
                        <select id="createTaskPriority" class="form-control">
                            <option value="none">ללא</option>
                            <option value="low">נמוכה</option>
                            <option value="medium">בינונית</option>
                            <option value="high">גבוהה</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="createTaskNotes">הערות:</label>
                    <textarea id="createTaskNotes" rows="4" placeholder="הוסף הערות כאן..."></textarea>
                </div>
                <div class="modal-actions">
                    <button id="createSaveBtn" class="btn btn-primary">צור משימה</button>
                </div>
            </div>
        </div>

        <!-- Edit Task Modal -->
        <div id="taskModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="modalTitle">עריכת משימה</h2>
                <div class="form-group">
                    <label for="projectNameInput">שם הפרויקט:</label>
                    <input type="text" id="projectNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label for="taskNameInput">שם המשימה:</label>
                    <input type="text" id="taskNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label>חברי צוות:</label>
                    <div class="members-select">
                        <!-- Populated dynamically by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskTeam">צוות:</label>
                    <select id="taskTeam" class="form-control">
                        <!-- Populated dynamically by JavaScript -->
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <label for="taskStatus">סטטוס:</label>
                        <select id="taskStatus" class="form-control">
                            <option value="status-inprogress">בתהליך</option>
                            <option value="status-done">הושלם</option>
                            <option value="status-notstarted">טרם החל</option>
                            <option value="status-delayed">מעוכב</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label for="taskPriority">עדיפות:</label>
                        <select id="taskPriority" class="form-control">
                            <option value="none">ללא</option>
                            <option value="low">נמוכה</option>
                            <option value="medium">בינונית</option>
                            <option value="high">גבוהה</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskNotes">הערות:</label>
                    <textarea id="taskNotes" rows="4" placeholder="הוסף הערות כאן..."></textarea>
                </div>
                <div class="modal-actions">
                    <button id="saveBtn" class="btn btn-primary">שמור שינויים</button>
                    <button id="deleteBtn" class="btn btn-danger">מחק משימה</button>
                </div>
            </div>
        </div>

        <script src="{{ url_for('static', filename='script.js') }}"></script>
        <script>
            // Add-task-per-project button logic
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('.add-task-project-btn').forEach(function (btn) {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        var projectName = btn.getAttribute('data-project');
                        var modal = document.getElementById('createTaskModal');
                        var projectInput = document.getElementById('createProjectNameInput');
                        if (projectInput) projectInput.value = projectName;
                        // Clear other fields
                        var nameInput = document.getElementById('createTaskNameInput');
                        if (nameInput) nameInput.value = '';
                        var statusInput = document.getElementById('createTaskStatus');
                        if (statusInput) statusInput.value = 'status-inprogress';
                        var priorityInput = document.getElementById('createTaskPriority');
                        if (priorityInput) priorityInput.value = 'none';
                        var notesInput = document.getElementById('createTaskNotes');
                        if (notesInput) notesInput.value = '';
                        document.querySelectorAll('#createTaskModal .members-select input[type="checkbox"]').forEach(function (cb) { cb.checked = false; });
                        modal.style.display = 'block';
                        modal.style.zIndex = 2000;
                        modal.style.visibility = 'visible';
                    });
                });
            });
        </script>
</body>

<script>
    // Live clock for navbar
    function updateClock() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        // Format: dd/mm/yyyy hh:mm:ss
        const formatted = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        const el = document.getElementById('liveClock');
        if (el) el.textContent = ` ${formatted} `;
    }
    setInterval(updateClock, 1000);
    updateClock();
</script>

<script>
    // Make member filter reset accessible globally
    window.resetMemberFilter = function () {
        const memberButtons = document.querySelectorAll('.filter-avatar-btn');
        memberButtons.forEach(mb => {
            mb.classList.remove('active');
        });
        const allTasks = document.querySelectorAll('.task-item');
        allTasks.forEach(task => {
            task.style.display = '';
        });
        // Trigger custom event to notify script.js
        window.dispatchEvent(new CustomEvent('resetMemberFilter'));
    };
</script>

<script>
    // Team filtering logic
    document.addEventListener('DOMContentLoaded', function () {
        const teamButtons = document.querySelectorAll('.filter-team-btn');
        const clearTeamBtn = document.getElementById('clearTeamFilter');
        const projectCards = document.querySelectorAll('.project-card');
        const memberButtons = document.querySelectorAll('.filter-avatar-btn');

        teamButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const teamId = this.getAttribute('data-team-id');

                // Update team button styles
                teamButtons.forEach(b => {
                    b.style.background = 'white';
                    b.style.borderColor = '#ddd';
                    b.style.color = 'inherit';
                    b.style.fontWeight = 'normal';
                });
                this.style.background = '#4F46E5';
                this.style.color = 'white';
                this.style.borderColor = '#4F46E5';
                this.style.fontWeight = 'bold';
                clearTeamBtn.style.background = '#f5f5f5';
                clearTeamBtn.style.color = 'inherit';

                // Clear any active member filter and reset task visibility
                if (typeof window.resetMemberFilter === 'function') {
                    window.resetMemberFilter();
                }

                // Filter member buttons - show only members from selected team
                memberButtons.forEach(mb => {
                    const memberTeamId = mb.getAttribute('data-team-id');
                    if (memberTeamId === teamId) {
                        mb.style.display = 'inline-block';
                    } else {
                        mb.style.display = 'none';
                    }
                });

                // Filter project cards
                projectCards.forEach(card => {
                    const cardTeamId = card.getAttribute('data-team-id');
                    if (cardTeamId === teamId) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        clearTeamBtn.addEventListener('click', function () {
            // Reset all team buttons
            teamButtons.forEach(b => {
                b.style.background = 'white';
                b.style.borderColor = '#ddd';
                b.style.color = 'inherit';
                b.style.fontWeight = 'normal';
            });
            this.style.background = '#4F46E5';
            this.style.color = 'white';

            // Clear any active member filter
            memberButtons.forEach(mb => {
                mb.classList.remove('active');
            });

            // Reset task filtering - show all tasks
            const taskItems = document.querySelectorAll('.task-item');
            taskItems.forEach(task => {
                task.style.display = 'list-item';
            });

            // Show all member buttons
            memberButtons.forEach(mb => {
                mb.style.display = 'inline-block';
            });

            // Show all project cards
            projectCards.forEach(card => {
                card.style.display = 'block';
            });
        });
    });
</script>
</script>
</body>

</html>