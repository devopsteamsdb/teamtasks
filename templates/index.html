<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח משימות</title>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="/" class="navbar-brand-link active"><span>לוח משימות</span></a>
            <a href="/calendar" class="navbar-brand-link"><span>לוח שנה</span></a>
        </div>


        <div class="search-container">
            <input type="text" id="searchBox" placeholder="חיפוש משימות..." class="search-input">
            <button id="clearSearch" class="clear-search-btn">×</button>
        </div>
        <!-- Team Filter Buttons -->
        <div class="team-filter-group">
            {% for team in teams %}
            <button class="filter-team-btn {% if active_team_id == team.id %}active{% endif %}"
                data-team-id="{{ team.id }}">
                {{ team.name_he }}
            </button>
            {% endfor %}
        </div>
        <div class="navbar-meta">
            <a href="/admin" title="ממשק ניהול" class="navbar-icon-link">
                <img src="{{ url_for('static', filename='icons/settings.svg') }}" width="20" height="20" alt="Settings"
                    class="icon-img">
            </a>

            <a href="/print" title="גרסת הדפסה" class="navbar-icon-link print-link">
                <img src="{{ url_for('static', filename='icons/print.svg') }}" width="20" height="20" alt="Print"
                    class="icon-img">
            </a>
            <img src="{{ url_for('static', filename='icons/clock.svg') }}" width="18" height="18" alt="Clock"
                class="icon-img">
            <span id="liveClock" style="padding-right: 1px;"></span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">

        <header class="dashboard-header">
            <div class="dashboard-title">
                <button id="addTaskBtn" class="btn-add-task">
                    <img src="{{ url_for('static', filename='icons/plus.svg') }}" width="18" height="18" alt="Add"> הוסף
                    משימה
                </button>
                <a href="/archive" class="btn-archive">
                    <img src="{{ url_for('static', filename='icons/archive.svg') }}" width="16" height="16"
                        alt="Archive" class="icon-img">
                    משימות בארכיון
                </a>
            </div>
            <div class="filter-controls">

                <!-- Member Filter Buttons (existing) -->
                {% for member in members %}
                <button class="filter-avatar-btn" data-member="{{ member.name_en }}" data-team-id="{{ member.team_id }}"
                    title="{{ member.name_he }}"
                    style="{% if active_team_id and member.team_id != active_team_id %}display:none;{% endif %}">
                    <img src="/uploads/avatars/{{ member.avatar_path }}" class="filter-avatar"
                        onerror="this.src='{{ url_for('static', filename='images/default.png') }}'">
                </button>
                {% endfor %}
            </div>
        </header>

        <div class="projects-grid">
            {% for project in projects %}
            {% set project_tasks = tasks|selectattr('project', 'equalto', project)|list %}
            {% set project_team_id = project_tasks|map(attribute='team_id')|first %}
            {% set project_visible = True %}
            {% if active_team_id %}
            {# Check if any task in project matches active team #}
            {% set matching_tasks = project_tasks|selectattr('team_id', 'equalto', active_team_id)|list %}
            {% if matching_tasks|length == 0 %}
            {% set project_visible = False %}
            {% endif %}
            {% endif %}

            <div class="project-card {% if not project_visible %}filtered-hidden{% endif %}"
                data-team-id="{{ project_team_id }}">
                <div class="project-header">
                    <span class="project-title">
                        <button class="add-task-project-btn" data-project="{{ project }}" title="הוסף משימה לפרויקט זה">
                            <img src="{{ url_for('static', filename='icons/plus-small.svg') }}" width="16" height="16"
                                alt="Add" class="icon-img">
                        </button>
                        {{ project }}
                    </span>
                    {% set project_colors = [
                    {'bg': '#EEF2FF', 'color': '#4F46E5'},
                    {'bg': '#ECFDF5', 'color': '#10B981'},
                    {'bg': '#FFF7ED', 'color': '#F97316'},
                    {'bg': '#FEF2F2', 'color': '#EF4444'},
                    {'bg': '#F0F9FF', 'color': '#0EA5E9'},
                    {'bg': '#FDF2FF', 'color': '#A21CAF'},
                    {'bg': '#F1F5F9', 'color': '#0F172A'},
                    {'bg': '#FFFBEB', 'color': '#CA8A04'},
                    {'bg': '#E0F2FE', 'color': '#0369A1'},
                    {'bg': '#F3F4F6', 'color': '#7C3AED'},
                    {'bg': '#FDE68A', 'color': '#B45309'},
                    {'bg': '#D1FAE5', 'color': '#047857'},
                    {'bg': '#FECACA', 'color': '#B91C1C'},
                    {'bg': '#EDE9FE', 'color': '#7C3AED'},
                    {'bg': '#C7D2FE', 'color': '#1D4ED8'}
                    ] %}
                    {# Priority colors: high=red, medium=orange, low=yellow, none/empty=gray #}
                    {% set priority_colors = {
                    'high': '#ef4444',
                    'medium': '#f59e0b',
                    'low': '#fde047',
                    'none': '#cbd5e1',
                    '': '#cbd5e1'
                    } %}
                    {% set color = project_colors[(loop.index0) % project_colors|length] %}
                    <span class="project-badge" style="background-color: {{ color.bg }}; color: {{ color.color }};">{{
                        project_teams.get(project) or 'כללי' }}</span>
                </div>
                <div class="project-body">
                    <ul class="task-list">
                        {% for task in tasks if task.project == project %}
                        <li class="task-item {% if active_team_id and task.team_id != active_team_id %}filtered-hidden{% endif %}"
                            data-id="{{ task.id }}" data-notes="{{ task.notes|default('') }}"
                            data-priority="{{ task.priority|default('none') }}" data-team-id="{{ task.team_id }}"
                            data-start-date="{{ task.start_date.isoformat() if task.start_date else '' }}"
                            data-end-date="{{ task.end_date.isoformat() if task.end_date else '' }}">
                            <div class="task-info">
                                <span class="task-marker"
                                    style="background-color: {{ priority_colors.get(task.priority, '#cbd5e1') }};"></span>
                                <span class="task-name">{{ task.task }}</span>
                                <span class="note-icon{% if not task.notes %} hidden{% endif %}" title="מכיל הערות"
                                    style="vertical-align:middle;">
                                    <img src="{{ url_for('static', filename='icons/note.svg') }}" width="16" height="16"
                                        alt="Note" style="vertical-align:middle;">
                                </span>
                            </div>

                            <div class="task-meta">
                                <div class="avatar-group">
                                    {% set member_list = task.members.split(',') if task.members else [] %}
                                    {% for member_name in member_list %}
                                    {% set member_key = member_name|lower|trim %}
                                    {% if member_key %}
                                    {% set member_obj = members|selectattr('name_en', 'equalto', member_key)|first %}
                                    {% if member_obj %}
                                    <img src="/uploads/avatars/{{ member_obj.avatar_path }}"
                                        onerror="this.src='{{ url_for('static', filename='images/default.png') }}'"
                                        class="avatar" title="{{ member_obj.name_he }}"
                                        data-member-name="{{ member_obj.name_en }}">
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="status-badge {{ task.status }}">{{ task.status|replace('status-inprogress',
                                    'בתהליך')|replace('status-done', 'הושלם')|replace('status-notstarted', 'טרם
                                    החל')|replace('status-delayed', 'מעוכב') }}</span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endfor %}
        </div>



    </div>
    </div>


    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-create">&times;</span>
            <h2 id="createModalTitle">יצירת משימה חדשה</h2>
            <div class="form-group">
                <label for="createTaskTeam">צוות:</label>
                <select id="createTaskTeam" class="form-control">
                    <!-- Populated dynamically by JavaScript -->
                </select>
            </div>
            <div class="form-group">
                <label for="createProjectNameInput">שם הפרויקט:</label>
                <input type="text" id="createProjectNameInput" class="form-control">
            </div>
            <div class="form-group">
                <label for="createTaskNameInput">שם המשימה:</label>
                <input type="text" id="createTaskNameInput" class="form-control">
            </div>
            <div class="form-group">
                <label>חברי צוות:</label>
                <div class="members-select">
                    <!-- Populated dynamically by JavaScript -->
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="createTaskStatus">סטטוס:</label>
                    <select id="createTaskStatus" class="form-control">
                        <option value="status-notstarted">טרם החל</option>
                        <option value="status-inprogress">בתהליך</option>
                        <option value="status-done">הושלם</option>
                        <option value="status-delayed">מעוכב</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label for="createTaskPriority">עדיפות:</label>
                    <select id="createTaskPriority" class="form-control">
                        <option value="none">ללא</option>
                        <option value="low">נמוכה</option>
                        <option value="medium">בינונית</option>
                        <option value="high">גבוהה</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="createTaskStartDate">תאריך התחלה (אופציונלי):</label>
                    <input type="text" id="createTaskStartDate" class="form-control" placeholder="dd/mm/yyyy">
                </div>
                <div class="form-group half">
                    <label for="createTaskEndDate">תאריך סיום (אופציונלי):</label>
                    <input type="text" id="createTaskEndDate" class="form-control" placeholder="dd/mm/yyyy">
                </div>
            </div>
            <div class="form-group">
                <label for="createTaskNotes">הערות:</label>
                <textarea id="createTaskNotes" rows="4" placeholder="הוסף הערות כאן..."></textarea>
            </div>
            <div class="modal-actions">
                <button id="createSaveBtn" class="btn btn-primary">צור משימה</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="modalTitle">עריכת משימה</h2>
            <div class="form-group">
                <label for="taskTeam">צוות:</label>
                <select id="taskTeam" class="form-control">
                    <!-- Populated dynamically by JavaScript -->
                </select>
                <div class="form-group">
                    <label for="projectNameInput">שם הפרויקט:</label>
                    <input type="text" id="projectNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label for="taskNameInput">שם המשימה:</label>
                    <input type="text" id="taskNameInput" class="form-control">
                </div>
                <div class="form-group">
                    <label>חברי צוות:</label>
                    <div class="members-select">
                        <!-- Populated dynamically by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="taskStatus">סטטוס:</label>
                    <select id="taskStatus" class="form-control">
                        <option value="status-notstarted">טרם החל</option>
                        <option value="status-inprogress">בתהליך</option>
                        <option value="status-done">הושלם</option>
                        <option value="status-delayed">מעוכב</option>
                    </select>
                </div>
                <div class="form-group half">
                    <label for="taskPriority">עדיפות:</label>
                    <select id="taskPriority" class="form-control">
                        <option value="none">ללא</option>
                        <option value="low">נמוכה</option>
                        <option value="medium">בינונית</option>
                        <option value="high">גבוהה</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="taskStartDate">תאריך התחלה (אופציונלי):</label>
                    <input type="text" id="taskStartDate" class="form-control" placeholder="dd/mm/yyyy">
                </div>
                <div class="form-group half">
                    <label for="taskEndDate">תאריך סיום (אופציונלי):</label>
                    <input type="text" id="taskEndDate" class="form-control" placeholder="dd/mm/yyyy">
                </div>
            </div>
            <div class="form-group">
                <label for="taskNotes">הערות:</label>
                <textarea id="taskNotes" rows="4" placeholder="הוסף הערות כאן..."></textarea>
            </div>
            <div class="modal-actions">
                <button id="saveBtn" class="btn btn-primary">שמור שינויים</button>
                <button id="archiveBtn" class="btn btn-secondary" style="margin-right: 10px;">ארכיון</button>
                <button id="deleteBtn" class="btn btn-danger">מחק משימה</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}?v=3"></script>
</body>

</html>